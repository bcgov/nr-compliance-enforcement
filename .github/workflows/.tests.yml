name: .Tests

on:
  workflow_call:
    inputs:
      ### Required
      target:
        description: PR number, test or prod
        required: true
        type: string

      ### Typical / recommended
      triggers:
        description: Bash array to diff for build triggering; omit to always fire
        required: false
        type: string

env:
  DOMAIN: apps.silver.devops.gov.bc.ca
  PREFIX: ${{ github.event.repository.name }}-${{ inputs.target }}

jobs:
  # Run sequentially to reduce chances of rate limiting
  zap_scan:
    runs-on: ubuntu-latest
    name: ZAP Scans
    env:
      DOMAIN: apps.silver.devops.gov.bc.ca
      PREFIX: ${{ github.event.repository.name }}-${{ inputs.target }}
    steps:
      - name: ZAP Scan - Frontend
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          allow_issue_writing: false
          artifact_name: "zap_frontend"
          cmd_options: "-a"
          issue_title: "ZAP: Frontend"
          target: https://${{ env.PREFIX }}-frontend.${{ env.DOMAIN }}
      - name: Check for High Risk Alerts
        run: |
          HIGH_RISK_COUNT=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' report_json.json)
          if [ "$HIGH_RISK_COUNT" -gt 0 ]; then
            echo "High risk issues found: $HIGH_RISK_COUNT"
            exit 1
          else
            echo "No high risk issues found."
          fi
  cypress-tests:
    env:
      DOMAIN: apps.silver.devops.gov.bc.ca
      PREFIX: ${{ github.event.repository.name }}-${{ inputs.target }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitCode
        uses: actions/checkout@v3

      - name: Debug secrets
        run: |
          echo "Checking secrets..."
          echo "auth_base_url: ${{ vars.KEYCLOAK_URL_DEV }}"
          echo "auth_realm: ${{ vars.KEYCLOAK_REALM }}"
          echo "keycloak_user: ${{ vars.KEYCLOAK_USER }}"
          echo "keycloak_client_id: ${{ vars.KEYCLOAK_CLIENT_ID }}"

        env:
          KEYCLOAK_PASSWORD: ${{ secrets.KEYCLOAK_PASSWORD }}

      - name: Run Cypress Test
        uses: cypress-io/github-action@v5
        with:
          working-directory: ./frontend
          command: npx cypress run --browser electron --config baseUrl=https://${{ env.PREFIX }}-frontend.${{ env.DOMAIN }} --env auth_base_url=${{ vars.KEYCLOAK_URL_DEV }},auth_realm=${{ vars.KEYCLOAK_REALM }},auth_client_id=${{ vars.KEYCLOAK_CLIENT_ID }},keycloak_user=${{ vars.KEYCLOAK_USER }},keycloak_user_02=${{ vars.KEYCLOAK_USER_02 }},keycloak_password=${{ secrets.KEYCLOAK_PASSWORD }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-artifacts
          path: |-
            /home/runner/work/nr-compliance-enforcement/nr-compliance-enforcement/frontend/cypress/videos/
            /home/runner/work/nr-compliance-enforcement/nr-compliance-enforcement/frontend/cypress/screenshots/
